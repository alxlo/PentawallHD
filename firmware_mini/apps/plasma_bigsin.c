#include <stdlib.h>
#include "main.h"
#include <stdio.h>

#ifdef __AVR__
#include <avr/pgmspace.h>
#else
typedef uint16_t prog_uint16_t;
typedef uint8_t prog_uint8_t;
#endif



prog_uint16_t sin_table[1024] =
{
	0,50,100,150,201,251,301,351,402,452,502,552,603,653,703,753,804,854,904,954,1004,1055,1105,1155,1205,1256,1306,1356,
	1406,1456,1507,1557,1607,1657,1707,1758,1808,1858,1908,1958,2008,2059,2109,2159,2209,2259,2309,2359,2410,2460,2510,2560,
	2610,2660,2710,2760,2810,2860,2911,2961,3011,3061,3111,3161,3211,3261,3311,3361,3411,3461,3511,3561,3611,3661,3710,3760,
	3810,3860,3910,3960,4010,4060,4110,4160,4209,4259,4309,4359,4409,4458,4508,4558,4608,4657,4707,4757,4807,4856,4906,4956,
	5005,5055,5105,5154,5204,5254,5303,5353,5402,5452,5501,5551,5601,5650,5700,5749,5799,5848,5897,5947,5996,6046,6095,6144,
	6194,6243,6292,6342,6391,6440,6490,6539,6588,6637,6687,6736,6785,6834,6883,6932,6981,7031,7080,7129,7178,7227,7276,7325,
	7374,7423,7472,7521,7569,7618,7667,7716,7765,7814,7862,7911,7960,8009,8057,8106,8155,8204,8252,8301,8349,8398,8447,8495,
	8544,8592,8641,8689,8738,8786,8834,8883,8931,8979,9028,9076,9124,9173,9221,9269,9317,9365,9414,9462,9510,9558,9606,9654,
	9702,9750,9798,9846,9894,9942,9990,10037,10085,10133,10181,10229,10276,10324,10372,10419,10467,10515,10562,10610,10657,
	10705,10752,10800,10847,10895,10942,10989,11037,11084,11131,11179,11226,11273,11320,11367,11414,11462,11509,11556,11603,
	11650,11697,11744,11790,11837,11884,11931,11978,12025,12071,12118,12165,12211,12258,12305,12351,12398,12444,12491,12537,
	12583,12630,12676,12723,12769,12815,12861,12908,12954,13000,13046,13092,13138,13184,13230,13276,13322,13368,13414,13460,
	13505,13551,13597,13643,13688,13734,13780,13825,13871,13916,13962,14007,14053,14098,14143,14189,14234,14279,14324,14370,
	14415,14460,14505,14550,14595,14640,14685,14730,14775,14820,14864,14909,14954,14999,15043,15088,15132,15177,15221,15266,
	15310,15355,15399,15444,15488,15532,15576,15621,15665,15709,15753,15797,15841,15885,15929,15973,16017,16060,16104,16148,
	16192,16235,16279,16323,16366,16410,16453,16497,16540,16583,16627,16670,16713,16756,16800,16843,16886,16929,16972,17015,
	17058,17101,17144,17186,17229,17272,17315,17357,17400,17442,17485,17527,17570,17612,17655,17697,17739,17781,17824,17866,
	17908,17950,17992,18034,18076,18118,18160,18201,18243,18285,18327,18368,18410,18451,18493,18534,18576,18617,18658,18700,
	18741,18782,18823,18864,18906,18947,18988,19028,19069,19110,19151,19192,19232,19273,19314,19354,19395,19435,19476,19516,
	19557,19597,19637,19677,19717,19758,19798,19838,19878,19918,19957,19997,20037,20077,20116,20156,20196,20235,20275,20314,
	20354,20393,20432,20472,20511,20550,20589,20628,20667,20706,20745,20784,20823,20862,20900,20939,20978,21016,21055,21093,
	21132,21170,21208,21247,21285,21323,21361,21399,21437,21475,21513,21551,21589,21627,21664,21702,21740,21777,21815,21852,
	21890,21927,21964,22002,22039,22076,22113,22150,22187,22224,22261,22298,22335,22372,22408,22445,22481,22518,22554,22591,
	22627,22664,22700,22736,22772,22808,22844,22880,22916,22952,22988,23024,23060,23095,23131,23166,23202,23237,23273,23308,
	23343,23379,23414,23449,23484,23519,23554,23589,23624,23659,23693,23728,23763,23797,23832,23866,23901,23935,23969,24004,
	24038,24072,24106,24140,24174,24208,24242,24275,24309,24343,24376,24410,24443,24477,24510,24544,24577,24610,24643,24676,
	24709,24742,24775,24808,24841,24874,24906,24939,24972,25004,25036,25069,25101,25133,25166,25198,25230,25262,25294,25326,
	25358,25390,25421,25453,25485,25516,25548,25579,25610,25642,25673,25704,25735,25766,25797,25828,25859,25890,25921,25952,
	25982,26013,26043,26074,26104,26135,26165,26195,26225,26255,26285,26315,26345,26375,26405,26435,26464,26494,26523,26553,
	26582,26612,26641,26670,26699,26728,26758,26786,26815,26844,26873,26902,26930,26959,26988,27016,27044,27073,27101,27129,
	27157,27186,27214,27241,27269,27297,27325,27353,27380,27408,27435,27463,27490,27518,27545,27572,27599,27626,27653,27680,
	27707,27734,27760,27787,27814,27840,27867,27893,27919,27946,27972,27998,28024,28050,28076,28102,28128,28154,28179,28205,
	28230,28256,28281,28307,28332,28357,28382,28407,28432,28457,28482,28507,28532,28556,28581,28606,28630,28654,28679,28703,
	28727,28751,28775,28799,28823,28847,28871,28895,28918,28942,28966,28989,29012,29036,29059,29082,29105,29128,29151,29174,
	29197,29220,29243,29265,29288,29310,29333,29355,29377,29400,29422,29444,29466,29488,29510,29532,29553,29575,29597,29618,
	29640,29661,29682,29703,29725,29746,29767,29788,29809,29830,29850,29871,29892,29912,29933,29953,29973,29994,30014,30034,
	30054,30074,30094,30114,30134,30153,30173,30192,30212,30231,30251,30270,30289,30308,30327,30346,30365,30384,30403,30422,
	30440,30459,30477,30496,30514,30532,30551,30569,30587,30605,30623,30640,30658,30676,30694,30711,30729,30746,30763,30781,
	30798,30815,30832,30849,30866,30883,30899,30916,30933,30949,30966,30982,30998,31015,31031,31047,31063,31079,31095,31111,
	31126,31142,31158,31173,31189,31204,31219,31235,31250,31265,31280,31295,31310,31324,31339,31354,31368,31383,31397,31411,
	31426,31440,31454,31468,31482,31496,31510,31524,31537,31551,31564,31578,31591,31604,31618,31631,31644,31657,31670,31683,
	31695,31708,31721,31733,31746,31758,31771,31783,31795,31807,31819,31831,31843,31855,31867,31878,31890,31901,31913,31924,
	31935,31947,31958,31969,31980,31991,32002,32012,32023,32034,32044,32055,32065,32075,32086,32096,32106,32116,32126,32136,
	32145,32155,32165,32174,32184,32193,32202,32212,32221,32230,32239,32248,32257,32266,32274,32283,32291,32300,32308,32317,
	32325,32333,32341,32349,32357,32365,32373,32381,32388,32396,32403,32411,32418,32425,32433,32440,32447,32454,32461,32467,
	32474,32481,32487,32494,32500,32507,32513,32519,32525,32531,32537,32543,32549,32555,32560,32566,32572,32577,32582,32588,
	32593,32598,32603,32608,32613,32618,32622,32627,32632,32636,32641,32645,32649,32654,32658,32662,32666,32670,32673,32677,
	32681,32684,32688,32691,32695,32698,32701,32704,32707,32710,32713,32716,32719,32722,32724,32727,32729,32731,32734,32736,
	32738,32740,32742,32744,32746,32748,32749,32751,32752,32754,32755,32756,32758,32759,32760,32761,32762,32763,32763,32764,
	32765,32765,32765,32766,32766,32766,32766,
};
// input 0..4095 ; output 0..65535
uint16_t sini(uint16_t x)
{
	x = x & 4095;

#ifdef __AVR__
	if(x < 1024) return pgm_read_word(&sin_table[x])+32767;
	if(x < 2048) return pgm_read_word(&sin_table[2047-x])+32767;
	if(x < 3072) return 32766-pgm_read_word(&sin_table[x-2048]);
	return 32766-pgm_read_word(&sin_table[4095-x]); 
#else
	if(x < 1024) return sin_table[x]+32767;
	if(x < 2048) return sin_table[2047-x]+32767;
	if(x < 3072) return 32766-sin_table[x-2048];
	return 32766-sin_table[4095-x]; 
#endif

}


static uint8_t tick(void) {
	static uint16_t a = 0;

	uint8_t x, y;

	uint16_t sin1 = sini(a)/5;
	uint16_t sin2 = sini(a*2)/3;
	uint16_t sin3 = sini(a*4);
	uint16_t sin4 = sini(a)/2;

	for(y = 0; y < LED_HEIGHT; y++) 
	{
		uint16_t y_part =  sini(sin2+y*64)  + sin3;

		for(x = 0; x < LED_WIDTH; x++) 
		{
			uint16_t h = sini(sin1+x*72)+ y_part;
			
			setLedXY(x,y,sini((h>>4)+sin1)>>8,sini(((h>>4)+sin2)+1365)>>8,sini(((h>>4)+sin4)+2730)>>8);

		}
	}
	a++;
	if(a==4096)
	{
		a=0;
	}
	return 0;
}

static void init(void) ATTRIBUTES

void init(void) {
	registerAnimation(tick, 4, 450);
}




