#include <stdlib.h>
#include "main.h"
#include <stdio.h>

#ifdef __AVR__
#include <avr/pgmspace.h>
#else
typedef uint16_t prog_uint16_t;
typedef uint8_t prog_uint8_t;
#endif



prog_uint16_t sin_table[1024] =
{
	0,50,100,150,201,251,301,351,402,452,502,552,603,653,703,753,804,854,904,954,1004,1055,1105,1155,1205,1256,1306,1356,
	1406,1456,1507,1557,1607,1657,1707,1758,1808,1858,1908,1958,2008,2059,2109,2159,2209,2259,2309,2359,2410,2460,2510,2560,
	2610,2660,2710,2760,2810,2860,2911,2961,3011,3061,3111,3161,3211,3261,3311,3361,3411,3461,3511,3561,3611,3661,3710,3760,
	3810,3860,3910,3960,4010,4060,4110,4160,4209,4259,4309,4359,4409,4458,4508,4558,4608,4657,4707,4757,4807,4856,4906,4956,
	5005,5055,5105,5154,5204,5254,5303,5353,5402,5452,5501,5551,5601,5650,5700,5749,5799,5848,5897,5947,5996,6046,6095,6144,
	6194,6243,6292,6342,6391,6440,6490,6539,6588,6637,6687,6736,6785,6834,6883,6932,6981,7031,7080,7129,7178,7227,7276,7325,
	7374,7423,7472,7521,7569,7618,7667,7716,7765,7814,7862,7911,7960,8009,8057,8106,8155,8204,8252,8301,8349,8398,8447,8495,
	8544,8592,8641,8689,8738,8786,8834,8883,8931,8979,9028,9076,9124,9173,9221,9269,9317,9365,9414,9462,9510,9558,9606,9654,
	9702,9750,9798,9846,9894,9942,9990,10037,10085,10133,10181,10229,10276,10324,10372,10419,10467,10515,10562,10610,10657,
	10705,10752,10800,10847,10895,10942,10989,11037,11084,11131,11179,11226,11273,11320,11367,11414,11462,11509,11556,11603,
	11650,11697,11744,11790,11837,11884,11931,11978,12025,12071,12118,12165,12211,12258,12305,12351,12398,12444,12491,12537,
	12583,12630,12676,12723,12769,12815,12861,12908,12954,13000,13046,13092,13138,13184,13230,13276,13322,13368,13414,13460,
	13505,13551,13597,13643,13688,13734,13780,13825,13871,13916,13962,14007,14053,14098,14143,14189,14234,14279,14324,14370,
	14415,14460,14505,14550,14595,14640,14685,14730,14775,14820,14864,14909,14954,14999,15043,15088,15132,15177,15221,15266,
	15310,15355,15399,15444,15488,15532,15576,15621,15665,15709,15753,15797,15841,15885,15929,15973,16017,16060,16104,16148,
	16192,16235,16279,16323,16366,16410,16453,16497,16540,16583,16627,16670,16713,16756,16800,16843,16886,16929,16972,17015,
	17058,17101,17144,17186,17229,17272,17315,17357,17400,17442,17485,17527,17570,17612,17655,17697,17739,17781,17824,17866,
	17908,17950,17992,18034,18076,18118,18160,18201,18243,18285,18327,18368,18410,18451,18493,18534,18576,18617,18658,18700,
	18741,18782,18823,18864,18906,18947,18988,19028,19069,19110,19151,19192,19232,19273,19314,19354,19395,19435,19476,19516,
	19557,19597,19637,19677,19717,19758,19798,19838,19878,19918,19957,19997,20037,20077,20116,20156,20196,20235,20275,20314,
	20354,20393,20432,20472,20511,20550,20589,20628,20667,20706,20745,20784,20823,20862,20900,20939,20978,21016,21055,21093,
	21132,21170,21208,21247,21285,21323,21361,21399,21437,21475,21513,21551,21589,21627,21664,21702,21740,21777,21815,21852,
	21890,21927,21964,22002,22039,22076,22113,22150,22187,22224,22261,22298,22335,22372,22408,22445,22481,22518,22554,22591,
	22627,22664,22700,22736,22772,22808,22844,22880,22916,22952,22988,23024,23060,23095,23131,23166,23202,23237,23273,23308,
	23343,23379,23414,23449,23484,23519,23554,23589,23624,23659,23693,23728,23763,23797,23832,23866,23901,23935,23969,24004,
	24038,24072,24106,24140,24174,24208,24242,24275,24309,24343,24376,24410,24443,24477,24510,24544,24577,24610,24643,24676,
	24709,24742,24775,24808,24841,24874,24906,24939,24972,25004,25036,25069,25101,25133,25166,25198,25230,25262,25294,25326,
	25358,25390,25421,25453,25485,25516,25548,25579,25610,25642,25673,25704,25735,25766,25797,25828,25859,25890,25921,25952,
	25982,26013,26043,26074,26104,26135,26165,26195,26225,26255,26285,26315,26345,26375,26405,26435,26464,26494,26523,26553,
	26582,26612,26641,26670,26699,26728,26758,26786,26815,26844,26873,26902,26930,26959,26988,27016,27044,27073,27101,27129,
	27157,27186,27214,27241,27269,27297,27325,27353,27380,27408,27435,27463,27490,27518,27545,27572,27599,27626,27653,27680,
	27707,27734,27760,27787,27814,27840,27867,27893,27919,27946,27972,27998,28024,28050,28076,28102,28128,28154,28179,28205,
	28230,28256,28281,28307,28332,28357,28382,28407,28432,28457,28482,28507,28532,28556,28581,28606,28630,28654,28679,28703,
	28727,28751,28775,28799,28823,28847,28871,28895,28918,28942,28966,28989,29012,29036,29059,29082,29105,29128,29151,29174,
	29197,29220,29243,29265,29288,29310,29333,29355,29377,29400,29422,29444,29466,29488,29510,29532,29553,29575,29597,29618,
	29640,29661,29682,29703,29725,29746,29767,29788,29809,29830,29850,29871,29892,29912,29933,29953,29973,29994,30014,30034,
	30054,30074,30094,30114,30134,30153,30173,30192,30212,30231,30251,30270,30289,30308,30327,30346,30365,30384,30403,30422,
	30440,30459,30477,30496,30514,30532,30551,30569,30587,30605,30623,30640,30658,30676,30694,30711,30729,30746,30763,30781,
	30798,30815,30832,30849,30866,30883,30899,30916,30933,30949,30966,30982,30998,31015,31031,31047,31063,31079,31095,31111,
	31126,31142,31158,31173,31189,31204,31219,31235,31250,31265,31280,31295,31310,31324,31339,31354,31368,31383,31397,31411,
	31426,31440,31454,31468,31482,31496,31510,31524,31537,31551,31564,31578,31591,31604,31618,31631,31644,31657,31670,31683,
	31695,31708,31721,31733,31746,31758,31771,31783,31795,31807,31819,31831,31843,31855,31867,31878,31890,31901,31913,31924,
	31935,31947,31958,31969,31980,31991,32002,32012,32023,32034,32044,32055,32065,32075,32086,32096,32106,32116,32126,32136,
	32145,32155,32165,32174,32184,32193,32202,32212,32221,32230,32239,32248,32257,32266,32274,32283,32291,32300,32308,32317,
	32325,32333,32341,32349,32357,32365,32373,32381,32388,32396,32403,32411,32418,32425,32433,32440,32447,32454,32461,32467,
	32474,32481,32487,32494,32500,32507,32513,32519,32525,32531,32537,32543,32549,32555,32560,32566,32572,32577,32582,32588,
	32593,32598,32603,32608,32613,32618,32622,32627,32632,32636,32641,32645,32649,32654,32658,32662,32666,32670,32673,32677,
	32681,32684,32688,32691,32695,32698,32701,32704,32707,32710,32713,32716,32719,32722,32724,32727,32729,32731,32734,32736,
	32738,32740,32742,32744,32746,32748,32749,32751,32752,32754,32755,32756,32758,32759,32760,32761,32762,32763,32763,32764,
	32765,32765,32765,32766,32766,32766,32766,
};
// input 0..4095 ; output 0..65535
uint16_t sini(uint16_t x)
{
	x = x & 4095;

#ifdef __AVR__
	if(x < 1024) return pgm_read_word(&sin_table[x])+32767;
	if(x < 2048) return pgm_read_word(&sin_table[2047-x])+32767;
	if(x < 3072) return 32766-pgm_read_word(&sin_table[x-2048]);
	return 32766-pgm_read_word(&sin_table[4095-x]); 
#else
	if(x < 1024) return sin_table[x]+32767;
	if(x < 2048) return sin_table[2047-x]+32767;
	if(x < 3072) return 32766-sin_table[x-2048];
	return 32766-sin_table[4095-x]; 
#endif

}


uint16_t nr, ng, nb;

uint16_t h;
uint16_t s=230;

prog_uint16_t table[] = { 0,1,2,2,3,4,5,5,6,7,8,9,9,10,11,12,13,13,14,15,16,17,17,18,19,20,21,21,22,23,24,25,25,26,27,28,28,29,30,31,32,32,33,34,35,36,36,37,38,39,40,40,41,42,43,44,44,45,46,47,48,48,49,50,51,51,52,53,54,55,55,56,57,58,59,59,60,61,62,63,63,64,65,66,67,67,68,69,70,70,71,72,73,74,74,75,76,77,78,78,79,80,81,82,82,83,84,85,86,86,87,88,89,89,90,91,92,93,93,94,95,96,97,97,98,99,100,101,101,102,103,104,104,105,106,107,108,108,109,110,111,112,112,113,114,115,116,116,117,118,119,119,120,121,122,123,123,124,125,126,127,127,128,129,130,131,131,132,133,134,134,135,136,137,138,138,139,140,141,142,142,143,144,145,146,146,147,148,149,150,150,151,152,153,153,154,155,156,157,157,158,159,160,161,161,162,163,164,165,165,166,167,168,168,169,170,171,172,172,173,174,175,176,176,177,178,179,180,180,181,182,183,183,184,185,186,187,187,188,189,190,191,191,192,193,194,195,195,196,197,198,199,199,200,201,202,202,203,204,205,206,206,207,208,209,210,210,211,212,213,214,214,215,216,217,218,218,219,220,
	221,221,222,223,224,225,225,226,227,228,229,229,230,231,232,233,233,234,235,236,237,237,238,239,240,240,241,242,243,244,244,245,246,247,248,248,249,250,251,252,252,253,254,255,256,256,257,258,259,260,260,261,262,263,264,264,265,266,267,268,268,269,270,271,272,272,273,274,275,276,276,277,278,279,280,280,281,282,283,284,284,285,286,287,288,288,289,290,291,292,292,293,294,295,296,296,297,298,299,300,300,301,302,303,304,304,305,306,307,308,308,309,310,311,312,312,313,314,315,316,316,317,318,319,320,320,321,322,323,324,324,325,326,327,328,329,329,330,331,332,333,333,334,335,336,337,337,338,339,340,341,341,342,343,344,345,346,346,347,348,349,350,350,351,352,353,354,355,355,356,357,358,359,359,360,361,362,363,363,364,365,366,367,368,368,369,370,371,372,373,373,374,375,376,377,377,378,379,380,381,382,382,383,384,385,386,387,387,388,389,390,391,391,392,393,394,395,396,396,397,398,399,400,401,401,402,403,404,405,406,406,407,408,409,410,411,412,412,413,414,415,416,417,417,418,
	419,420,421,422,422,423,424,425,426,427,428,428,429,430,431,432,433,433,434,435,436,437,438,439,439,440,441,442,443,444,445,445,446,447,448,449,450,451,451,452,453,454,455,456,457,457,458,459,460,461,462,463,463,464,465,466,467,468,469,470,470,471,472,473,474,475,476,477,477,478,479,480,481,482,483,484,484,485,486,487,488,489,490,491,492,492,493,494,495,496,497,498,499,500,501,501,502,503,504,505,506,507,508,509,510,510,511,512,513,514,515,516,517,518,519,520,520,521,522,523,524,525,526,527,528,529,530,531,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,644,645,646,647,
	648,649,650,651,652,653,654,655,657,658,659,660,661,662,663,664,665,666,668,669,670,671,672,673,674,675,677,678,679,680,681,682,683,685,686,687,688,689,690,692,693,694,695,696,697,699,700,701,702,703,704,706,707,708,709,710,712,713,714,715,716,718,719,720,721,723,724,725,726,727,729,730,731,732,734,735,736,737,739,740,741,742,744,745,746,748,749,750,751,753,754,755,757,758,759,761,762,763,764,766,767,768,770,771,772,774,775,776,778,779,781,782,783,785,786,787,789,790,792,793,794,796,797,799,800,801,803,804,806,807,808,810,811,813,814,816,817,819,820,822,823,824,826,827,829,830,832,833,835,836,838,839,841,842,844,846,847,849,850,852,853,855,856,858,860,861,863,864,866,867,869,871,872,874,875,877,879,880,882,884,885,887,889,890,892,894,895,897,899,900,902,904,905,907,909,911,912,914,916,918,919,921,923,925,926,928,930,932,934,935,937,939,941,943,944,946,948,950,952,954,956,957,959,961,963,965,967,969,971,973,975,977,979,981,982,984,986,988,990,992,994,996,998,1000,1002,
	1005,1007,1009,1011,1013,1015,1017,1019,1021,1023};

void hsv_to_rgb(void)	
{
	uint16_t R,G,B;			

	uint32_t i,f;
	uint16_t p, q, t;

	if( s == 0 ) 
	{
		nr=1023;										// Auf 8 Bit RGB skalieren, nacher nur noch kopieren
		ng=1023;
		nb=1023;	
		return;
	}

	i = (((uint32_t)h) * 6) & 0xFF0000;
	f = ((((uint32_t)h) * 6) - i)>>8;
	i >>= 16;
	p = 65535 - s * 256;
	q = 65535 - s * f;
	t = 65535 - s * (256 - f);

	switch( i )
	{
		case 0:
			R = 65535; G = t; B = p; break;
		case 1:
			R = q; G = 65535; B = p; break;
		case 2:
			R = p; G = 65535; B = t; break;
		case 3:
			R = p; G = q; B = 65535; break;			
		case 4:
			R = t; G = p; B = 65535; break;
		default:								
			R = 65535; G = p; B = q; break;				// case 5:					
	}

	#ifdef __AVR__
	nr=pgm_read_word(&table[R>>6]);
	ng=pgm_read_word(&table[G>>6]);
	nb=pgm_read_word(&table[B>>6]);
	#else
	nr=table[R>>6];
	ng=table[G>>6];
	nb=table[B>>6];
	#endif


}

static uint8_t tick(void) {
	static uint16_t a = 0;

	uint8_t x, y;

	uint16_t sin1 = sini(a)/5;
	uint16_t sin2 = sini(a*2)/3;
	uint16_t sin3 = sini(a*16)/2;

	for(y = 0; y < LED_HEIGHT; y++) 
	{
		uint16_t y_part = h = sini(sin2+y*60)/2  + sin3;

		for(x = 0; x < LED_WIDTH; x++) 
		{
			h = sini(sin1+x*31)+ y_part;
			
			hsv_to_rgb();
			setLedXY(x, y, nr>>2,ng>>2,nb>>2);
		}
	}
	a++;
	if(a==4096)
	{
		a=0;
	}
	return 0;
}

static void init(void) ATTRIBUTES
void init(void) {
	registerAnimation(tick, 4, 450);
}




